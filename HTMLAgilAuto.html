<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agilauto — Espace commerciaux</title>
  <link rel="icon" href="https://content.sofinco.fr/files/live/sites/contentAgilauto/files/img/visuals/logo-agilauto.svg">
  <style>
    :root{ --aa-blue:#0b5aa6; --aa-blue-2:#2f79d8; --aa-green:#3ab17a; --aa-bg:#f5f8fc; --aa-text:#00254d; --aa-border:#e6eef7; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--aa-bg);color:var(--aa-text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{display:flex;align-items:center;gap:16px;padding:12px 20px;background:#fff;border-bottom:1px solid var(--aa-border);position:sticky;top:0;z-index:10}
    header img{height:34px}
    header h1{font-size:18px;margin:0;font-weight:700}
    .container{max-width:1200px;margin:0 auto;padding:16px 20px 40px}
    .tabs{display:flex;gap:8px;padding:8px 0 16px}
    .tab-btn{border:1px solid var(--aa-border);background:#fff;color:var(--aa-blue);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .tab-btn.active{background:var(--aa-blue);border-color:var(--aa-blue);color:#fff}
    .panel{display:none}
    .panel.active{display:block}
    .card{background:#fff;border:1px solid var(--aa-border);border-radius:14px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.04);margin:12px 0}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    label{display:block;font-size:12px;color:#5a6d86;margin-bottom:6px}
    input,select,textarea,button{border:1px solid var(--aa-border);border-radius:10px;padding:10px 12px;font:inherit;outline:none;background:#fff;color:var(--aa-text)}
    input:focus,select:focus,textarea:focus{border-color:var(--aa-blue)}
    button.primary{background:var(--aa-blue);color:#fff;border-color:var(--aa-blue);cursor:pointer}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px 12px}
    .list{display:grid;gap:12px}
    .muted{color:#6b7d95}
    .car{display:flex;gap:14px}
    .car img{width:180px;height:112px;object-fit:cover;border-radius:10px;border:1px solid var(--aa-border)}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#edf4ff;color:var(--aa-blue)}
  </style>
</head>
<body>
  <header class="container">
    <img src="https://content.sofinco.fr/files/live/sites/contentAgilauto/files/img/visuals/logo-agilauto.svg" alt="Agilauto" />
    <h1>Espace commerciaux — Maquette UI</h1>
  </header>

  <div class="container">
    <nav class="tabs">
      <button class="tab-btn active" data-tab="fleet">Gestionnaire de flottes</button>
      <button class="tab-btn" data-tab="account">Compte</button>
      <button class="tab-btn" data-tab="lead">Lead</button>
    </nav>

    <!-- Onglet 1: Gestionnaire de flottes -->
    <section id="panel-fleet" class="panel active">
      <div class="card">
        <h2 style="margin-top:0">Recherche gestionnaire</h2>
        <div class="row">
          <div class="col">
            <label>Email du gestionnaire</label>
            <input id="fleet-email" />
          </div>
          <div class="col" style="align-self:end">
            <button class="primary" id="btn-search-fleet">Rechercher</button>
          </div>
        </div>
      </div>

      <div class="card" id="fleet-fiche">
        <h3>Fiche gestionnaire</h3>
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px">
          <div class="kv" style="flex:1">
            <div>Nom / Prénom</div><div><strong id="fleet-name">—</strong></div>
            <div>Email</div><div id="fleet-email-out">—</div>
            <div>Téléphone</div><div id="fleet-mobile">—</div>
            <div>Origine</div><div id="fleet-origin">—</div>
            <div>Dernière MAJ</div><div id="fleet-updated">—</div>
          </div>
          <div>
            <img src="https://lh3.googleusercontent.com/p/AF1QipMZynAxIUI5Er2oytYc8XWCdG2vlbW-vYjQ9uHf=s1360-w1360-h1020-rw" alt="Logo KPC" style="height:60px;object-fit:contain;border-radius:8px;border:1px solid var(--aa-border)" />
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Contrats liés à ce gestionnaire</h3>
        <div class="list" id="fleet-contracts">
          <div class="muted">(À brancher sur l'API Contrats)</div>
        </div>
      </div>
    </section>

    <!-- Onglet 2: Compte -->
    <section id="panel-account" class="panel">
      <div class="card">
        <h2 style="margin-top:0">Recherche compte</h2>
        <div class="row">
          <div class="col">
            <label>Nom du compte</label>
            <input id="account-name" />
          </div>
          <div class="col" style="align-self:end">
            <button class="primary" id="btn-search-account">Rechercher</button>
          </div>
        </div>
      </div>

      <div class="card" id="account-fiche">
        <h3 style="margin-top:0">Fiche entreprise</h3>
        <div class="kv">
          <div>Raison sociale</div><div><strong id="acc-brand">—</strong></div>
          <div>SIREN</div><div id="acc-siren">—</div>
          <div>Adresse</div><div id="acc-address">—</div>
          <div>Pays</div><div id="acc-country">—</div>
          <div>Téléphone</div><div id="acc-phone">—</div>
          <div>Email</div><div id="acc-email">—</div>
          <div>Site web</div><div id="acc-url">—</div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Liste gestionnaires</h3>
        <div class="list" id="account-managers"><div class="muted">(Résultats après recherche compte)</div></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Contrats du compte</h3>
        <div class="list" id="account-contracts"><div class="muted">(Résultats après recherche compte)</div></div>
      </div>
    </section>

    <!-- Onglet 3: Lead -->
    <section id="panel-lead" class="panel">
      <div class="card">
        <h2 style="margin-top:0">Créer / mettre à jour un lead</h2>
        <div class="row">
          <div class="col"><label>Email</label><input placeholder="prenom.nom@entreprise.com" /></div>
          <div class="col"><label>Prénom</label><input placeholder="Prénom" /></div>
          <div class="col"><label>Nom</label><input placeholder="Nom" /></div>
          <div class="col"><label>Téléphone</label><input placeholder="+33…" /></div>
          <div class="col"><label>Opt-in Email</label><select><option>Oui</option><option>Non</option></select></div>
          <div class="col"><label>Opt-in SMS</label><select><option>Oui</option><option>Non</option></select></div>
        </div>
        <div style="margin-top:12px"><button class="primary">Enregistrer</button><span class="muted" style="margin-left:8px">(message de statut)</span></div>
      </div>
    </section>
  </div>

  <script>
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const id = btn.dataset.tab;
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById('panel-'+id).classList.add('active');
      });
    });

    const API_KEY = '1ad6eccb-055d-4600-9b4f-571165af3982';
    const FLEET_BASE = 'https://francois-sandbox.saas.imagino.com/ucdapi/Vue_gestionnaire_de_flotte/1';
    const ACCOUNT_BASE = 'https://francois-sandbox.saas.imagino.com/ucdapi/Vue_Account_API/1';
    const CONTRACT_BASE = 'https://francois-sandbox.saas.imagino.com/ucdapi/Contrat/1';

  async function fetchJSON(url){
  const res = await fetch(url, { headers: { 'X-Api-Key': API_KEY }});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}
function getManagerSapContactId(obj){
  // Try common keys
  const direct = obj.SAP_CONTACT_ID || obj.sapContactId || obj.sap_contact_id || obj.contactSapId || obj.id;
  if (direct) return String(direct);

  // Fallback: scan keys looking for “sap…contact…id”
  for (const k of Object.keys(obj||{})){
    if (/sap.*contact.*id/i.test(k)) return String(obj[k]);
  }
  return undefined;
}


    async function searchFleetByEmail(email){
      const js = await fetchJSON(`${FLEET_BASE}/Vue_Gestionnaires_de_flotte?limit=1000`);
      const list = (js && js.data) || [];
      const e = email.trim().toLowerCase();
      return list.find(x => (x.email||'').toLowerCase() === e) || list.find(x => (x.email||'').toLowerCase().includes(e));
    }

    async function searchAccountByName(name){
      const js = await fetchJSON(`${ACCOUNT_BASE}/Vue_account?limit=1000`);
      const list = (js && js.data) || [];
      const n = name.trim().toLowerCase();
      return list.find(x => (x.brand||'').toLowerCase().includes(n));
    }

    function setText(id, val){ const el = document.getElementById(id); if(el) el.textContent = val ?? '—'; }

    document.getElementById('btn-search-fleet')?.addEventListener('click', async ()=>{
      const email = (document.getElementById('fleet-email')?.value || '').trim();
      if(!email){ alert('Saisir un email gestionnaire'); return; }
      try{
        const rec = await searchFleetByEmail(email);
        if(!rec){ alert('Aucun gestionnaire trouvé'); return; }
        setText('fleet-name', `${rec.firstName||''} ${rec.lastName||''}`.trim() || '—');
        setText('fleet-email-out', rec.email||'—');
        setText('fleet-mobile', rec.mobile||'—');
        setText('fleet-origin', rec.origin||'—');
        setText('fleet-updated', rec.lastModifiedDate ? new Date(rec.lastModifiedDate).toLocaleString('fr-FR') : '—');
        await populateFleetContracts(rec);
      }catch(e){ console.error(e); alert('Erreur API gestionnaire'); }
    });

    document.getElementById('btn-search-account')?.addEventListener('click', async ()=>{
  const name = (document.getElementById('account-name')?.value || '').trim();
  if(!name){ alert('Saisir un nom de compte'); return; }
  try{
    const rec = await searchAccountByName(name);
    if(!rec){ alert('Compte introuvable'); return; }

    setText('acc-brand', rec.brand||'—');
    setText('acc-siren', rec.SIREN||'—');
    setText('acc-address', rec.addressLine||'—');
    setText('acc-country', rec.country||'—');
    setText('acc-phone', rec.telephone||'—');
    setText('acc-email', rec.email||'—');
    setText('acc-url', rec.url||'—');

    // Alimente les sections
    await Promise.all([
      populateAccountManagers(rec),
      populateAccountContracts(rec)
    ]);
  }catch(e){
    console.error(e);
    alert('Erreur API compte');
  }
});
    // ===== Helpers contrats =====
    function buildCarImage(make, model, color){
      const m = encodeURIComponent(make||'');
      const f = encodeURIComponent(model||'');
      const p = encodeURIComponent(color||'');
      // Fallback vers une image Imagin si pas d'URL fournie par l'API
      return `https://cdn.imagin.studio/getImage?customer=frcacf&make=${m}&modelFamily=${f}&angle=01&paintDescription=${p}&modelYear=2025&tailoring=agilauto&zoomType=fullscreen&witdh=800`;
    }
    function normalizeContract(raw){
      return {
        vehicleMake: raw.VEHICLE_MAKE ?? raw.vehicleMake,
        vehicleModel: raw.VEHICLE_MODEL ?? raw.vehicleModel,
        vehicleTrim:  raw.VEHICLE_TRIM  ?? raw.vehicleTrim,
        vehicleColor: raw.VEHICLE_COLOR ?? raw.vehicleColor,
        vehicleTransmission: raw.VEHICLE_TRANSMISSION ?? raw.vehicleTransmission,
        amount:   raw.AMOUNT ?? raw.amount,
        status:   raw.STATUS ?? raw.status,
        startDate: raw.START_DATE ?? raw.startDate,
        endDate:   raw.END_DATE   ?? raw.endDate,
        vin:       raw.VIN ?? raw.vin,
        imageUrl:  raw.VEHICLE_IMAGE_URL ?? raw.imageUrl,
        driverName: ((raw.Prenom_Conducteur||'') + ' ' + (raw.Nom_conducteur||'')).trim() || raw.DRIVER_NAME || raw.driverName,
        driverContactId: raw.DRIVER_CONTACT_ID || raw.driverContactId,
        fleetManagerId: raw.FLEET_MANAGER_CONTACT_ID || raw.fleetManagerContactId,
        accountId: raw.SAP_ACCOUNT_ID || raw.accountId
      };
    }
    function contractCardHTML(raw){
      const c = normalizeContract(raw);
      const img = c.imageUrl || buildCarImage(c.vehicleMake, c.vehicleModel, c.vehicleColor);
      const status = c.status || '—';
      const title = [c.vehicleMake, c.vehicleModel, c.vehicleTrim].filter(Boolean).join(' ') || 'Véhicule';
      const driver = c.driverName || (c.driverContactId ? `ID ${c.driverContactId}` : '—');
      const vin = c.vin || '—';
      const amount = (c.amount!=null) ? `${c.amount} €/mois` : '';
      const start = c.startDate ? new Date(c.startDate).toLocaleDateString('fr-FR') : '—';
      const end = c.endDate ? new Date(c.endDate).toLocaleDateString('fr-FR') : '—';
      return `<div class="car card">
        <img src="${img}" alt="${title}" />
        <div>
          <div class="tag">${status}</div>
          <h4 style="margin:6px 0 4px">${title}</h4>
          <div class="muted">Conducteur : ${driver} • VIN ${vin}</div>
          <div class="muted">Début ${start} • Fin ${end} ${amount? '• '+amount : ''}</div>
        </div>
      </div>`;
    }

 async function populateFleetContracts(manager){
  const box = document.getElementById('fleet-contracts');
  box.innerHTML = '<div class="muted">Chargement…</div>';
  try{
    // Correct endpoint from your Swagger
    const all = await fetchJSON(`${CONTRACT_BASE}/DEMOFR_AGIL_RAW_SAP_CONTRACT?limit=10000`);
    const rows = (all && all.data) || [];

    const managerId = getManagerSapContactId(manager); // e.g. "FMKPC01"
    const related = rows.filter(r => String(r.FLEET_MANAGER_CONTACT_ID||'') === String(managerId||''));

    box.innerHTML = '';
    if (!related.length){
      box.innerHTML = '<div class="muted">Aucun contrat trouvé pour ce gestionnaire</div>';
      return;
    }

    // Render cards
    const html = related.map(r => {
      const c = {
        vehicleMake: r.VEHICLE_MAKE,
        vehicleModel: r.VEHICLE_MODEL,
        vehicleTrim:  r.VEHICLE_TRIM,
        vehicleColor: r.VEHICLE_COLOR,
        amount:       r.AMOUNT,
        status:       r.STATUS,
        startDate:    r.START_DATE,
        endDate:      r.END_DATE,
        vin:          r.VIN,
        imageUrl:     r.VEHICLE_IMAGE_URL,
        driverName:   ((r.Prenom_Conducteur||'') + ' ' + (r.Nom_conducteur||'')).trim()
      };
      const img = c.imageUrl || `https://cdn.imagin.studio/getImage?customer=frcacf&make=${encodeURIComponent(c.vehicleMake||'')}&modelFamily=${encodeURIComponent(c.vehicleModel||'')}&angle=01&paintDescription=${encodeURIComponent(c.vehicleColor||'')}&modelYear=2025&tailoring=agilauto&zoomType=fullscreen&witdh=800`;
      const start = c.startDate ? new Date(c.startDate).toLocaleDateString('fr-FR') : '—';
      const end   = c.endDate   ? new Date(c.endDate).toLocaleDateString('fr-FR') : '—';
      return `
        <div class="car card">
          <img src="${img}" alt="${(c.vehicleMake||'')+' '+(c.vehicleModel||'')}" />
          <div>
            <div class="tag">${c.status||'—'}</div>
            <h4 style="margin:6px 0 4px">${[c.vehicleMake,c.vehicleModel,c.vehicleTrim].filter(Boolean).join(' ')||'Véhicule'}</h4>
            <div class="muted">Conducteur : ${c.driverName||'—'} • VIN ${c.vin||'—'}</div>
            <div class="muted">Début ${start} • Fin ${end} ${c.amount!=null ? '• '+c.amount+' €/mois':''}</div>
          </div>
        </div>`;
    }).join('');
    box.innerHTML = html;

  }catch(e){
    console.error(e);
    box.innerHTML = '<div class="muted">Erreur chargement contrats</div>';
  }
}
// === Helpers pour le compte ===
function getAccountId(acc){
  return acc.SAP_ACCOUNT_ID || acc.sapAccountId || acc.accountId || acc.account_id || acc.id || '';
}
function getAccountBrand(acc){
  return (acc.brand || acc.accountBrand || acc.company || '').toString().toLowerCase();
}

// Petite carte "gestionnaire"
function renderManagerCard(m){
  const initials = `${(m.firstName||'?')[0]||'?'}${(m.lastName||'?')[0]||''}`.toUpperCase();
  const email = m.email || '—';
  const phone = m.mobile || m.phone || '—';
  return `
    <div class="card" style="display:flex;align-items:center;gap:14px">
      <div style="width:44px;height:44px;border-radius:50%;background:#edf4ff;border:1px solid var(--aa-border);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--aa-blue)">${initials}</div>
      <div>
        <div><strong>${[m.firstName,m.lastName].filter(Boolean).join(' ')}</strong> <span class="tag">Gestionnaire de flotte</span></div>
        <div class="muted">${email} • ${phone}</div>
      </div>
    </div>`;
}

// === Liste des gestionnaires du compte (ID compte = "KPC" accepté) ===
// === Liste des gestionnaires du compte ===
async function populateAccountManagers(account){
  const box = document.getElementById('account-managers');
  box.innerHTML = '<div class="muted">Chargement…</div>';
  try{
    const js = await fetchJSON(`${FLEET_BASE}/Vue_Gestionnaires_de_flotte?limit=10000`);
    const all = (js && js.data) || [];

    const wantedAccId = (account && (account.SAP_ACCOUNT_ID || account.sapAccountId || account.accountId)) || '';
    const byEmail = m => (m.email||'').toLowerCase().includes('kpc');
    const byAccount = m => wantedAccId && String(m.SAP_ACCOUNT_ID||m.accountId||'') === String(wantedAccId);

    // filtre demandé (email contient "kpc") + match par compte si fourni
    const filtered = all.filter(m => byEmail(m) || byAccount(m));

    // dédoublonnage par email
    const seen = new Set();
    const unique = filtered.filter(m=>{
      const e = (m.email||'').toLowerCase();
      if(seen.has(e)) return false;
      seen.add(e);
      return true;
    });

    box.innerHTML = unique.length
      ? unique.map(renderManagerCard).join('')   // <-- corrige le nom de la fonction
      : '<div class="muted">Aucun gestionnaire rattaché à ce compte</div>';
  }catch(e){
    console.error(e);
    box.innerHTML = '<div class="muted">Erreur chargement gestionnaires</div>';
  }
}


// === Contrats du compte (filtre via SAP_ACCOUNT_ID ; tolère "KPC") ===
async function populateAccountContracts(account){
  const box = document.getElementById('account-contracts');
  box.innerHTML = '<div class="muted">Chargement…</div>';

  try{
    const all = await fetchJSON(`${CONTRACT_BASE}/DEMOFR_AGIL_RAW_SAP_CONTRACT?limit=10000`);
    const rows = (all && all.data) || [];

    const accId = String(getAccountId(account));
    const brand = getAccountBrand(account);
    const isKPC = accId.toUpperCase()==='KPC' || brand.includes('kpc');

    const related = rows.filter(r=>{
      const rAcc = String(r.SAP_ACCOUNT_ID || r.account_id || '');
      const rBrand = (r.accountBrand || '').toString().toLowerCase();
      return (accId && rAcc && rAcc === accId)
          || (isKPC && (rAcc.toUpperCase().includes('KPC') || rBrand.includes('kpc')));
    });

    box.innerHTML = related.length
      ? related.map(contractCardHTML).join('')
      : '<div class="muted">Aucun contrat pour ce compte</div>';
  }catch(e){
    console.error(e);
    box.innerHTML = '<div class="muted">Erreur chargement contrats</div>';
  }

}
</script>
</body>
</html>
